from flask import Flask, request, jsonify, redirect, url_for
from flask_cors import CORS
from werkzeug.utils import secure_filename
import csv
import os
import uuid
import number_recognition

UPLOAD_FOLDER = '/tmp/videos_uploads'
os.makedirs(UPLOAD_FOLDER, exist_ok=True)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
CORS(app)

RESULTS = {}

@app.route("/health", methods=["GET"])
def health_check():
    return jsonify({'status': "ok"}), 200

@app.route("/upload", methods=["POST"])
def upload_video():
    if 'video' not in request.files:
        return jsonify({"message": "You must include a valid video"}), 400
        
    video = request.files["video"]
    video_id = str(uuid.uuid4())
    video_path = os.path.join(app.config["UPLOAD_FOLDER"], f"{video_id}.mp4")
    video.save(video_path)

    # force_time_data = {t: 5 + 0.5 * t for t in range(10)}
    # force_time_data = {'0.1589808464050293': '0.0', '0.2835228443145752': '0.0', '0.327847957611084': '0.0001', '0.3584022521972656': '0.0001', '0.3864481449127197': '0.0', '0.3988678455352783': '0.0', '0.4171292781829834': '0.0', '0.4329237937927246': '0.0', '0.4494161605834961': '0.0', '0.4605851173400879': '0.0', '0.4797701835632324': '0.0', '0.501533031463623': '0.0', '0.5262224674224854': '0.0', '0.5423314571380615': '0.0', '0.5934748649597168': '0.005', '0.6300210952758789': '0.065', '0.6509349346160889': '0.165', '0.6640782356262207': '0.16', '0.6804862022399902': '0.16', '0.7022080421447754': '0.245', '0.7288498878479004': '0.245', '0.7513439655303955': '0.245', '0.7779703140258789': '0.295', '0.8177444934844971': '0.295', '0.8374967575073242': '0.295', '0.8526492118835449': '0.295', '0.8756933212280273': '0.12', '0.8996269702911377': '0.12', '0.9182372093200684': '0.43', '0.9326164722442627': '0.49', '0.9475927352905273': '0.4', '0.961798906326294': '0.4', '0.9801955223083496': '0.6', '0.995948076248169': '0.67', '1.0180625915527344': '0.67', '1.0381922721862793': '0.575', '1.0549328327178955': '0.935', '1.0726966857910156': '0.73', '1.0963284969329834': '0.79', '1.1210098266601562': '0.79', '1.1373391151428223': '0.79', '1.1552941799163818': '0.86', '1.1820425987243652': '0.895', '1.2044312953948975': '0.895', '1.2264776229858398': '0.895', '1.2437362670898438': '0.99', '1.26143479347229': '0.99', '1.275033950805664': '0.99', '1.2929582595825195': '1.02', '1.319185733795166': '1.02', '1.333803653717041': '1.085', '1.35158109664917': '1.085', '1.374115228652954': '1.13', '1.3969221115112305': '1.13', '1.411616563796997': '1.135', '1.4301259517669678': '1.135', '1.4467897415161133': '1.195', '1.4768271446228027': '1.295', '1.5136394500732422': '1.295', '1.5278429985046387': '1.295', '1.5509376525878906': '1.55', '1.5660054683685303': '1.55', '1.5913872718811035': '1.4', '1.6125092506408691': '1.4', '1.630629062652588': '1.445', '1.6451215744018555': '1.445', '1.6702637672424316': '1.52', '1.6957495212554932': '1.52', '1.7292768955230713': '1.52', '1.7525992393493652': '1.605', '1.7677788734436035': '1.605', '1.7929184436798096': '1.65', '1.825331211090088': '1.65', '1.8514070510864258': '1.65', '1.8656418323516846': '1.65', '1.8755104541778564': '1.65', '1.8885812759399414': '1.65', '1.9025261402130127': '1.715', '1.9264585971832275': '1.055', '1.9412031173706055': '1.855', '1.9540939331054688': '1.855', '1.9711127281188965': '1.86', '1.9872040748596191': '1.86', '2.0046346187591553': '1.875', '2.0186686515808105': '1.875', '2.034954786300659': '1.875', '2.0592429637908936': '1.9', '2.0825047492980957': '1.9', '2.0982327461242676': '1.97', '2.1201975345611572': '1.97', '2.146806240081787': '1.97', '2.1548027992248535': '1.97', '2.177231550216675': '2.03', '2.204742908477783': '2.295', '2.2247190475463867': '2.295', '2.2468862533569336': '2.17', '2.271613597869873': '2.17', '2.2803573608398438': '2.17', '2.297884941101074': '2.205', '2.3199949264526367': '2.205', '2.332547903060913': '2.255', '2.3480331897735596': '2.255', '2.3625452518463135': '2.255', '2.3704617023468018': '2.255', '2.3813154697418213': '2.255', '2.399461507797241': '2.125', '2.4138009548187256': '2.425', '2.4266397953033447': '2.425', '2.438901662826538': '2.425', '2.452501058578491': '2.425', '2.4715895652770996': '2.505', '2.4988200664520264': '2.505', '2.533168077468872': '2.525', '2.551542043685913': '2.525', '2.5665745735168457': '2.525', '2.5829408168792725': '2.525', '2.5965540409088135': '2.525', '2.614773988723755': '2.525', '2.6304633617401123': '2.525', '2.6482198238372803': '2.525', '2.6761133670806885': '2.525', '2.689645767211914': '2.525', '2.703084945678711': '2.525', '2.715792655944824': '2.47', '2.742299795150757': '2.43', '2.777785062789917': '2.45', '2.8070640563964844': '2.45', '2.8378281593322754': '2.45', '2.8611862659454346': '2.45', '2.875006675720215': '2.45', '2.888111114501953': '2.45', '2.9069900512695312': '2.44', '2.920193672180176': '2.44', '2.93241024017334': '2.415', '2.9560017585754395': '2.415', '2.96551775932312': '2.415', '2.983299970626831': '2.415', '2.992675542831421': '2.415', '3.0171236991882324': '2.415', '3.031602621078491': '2.415', '3.0467987060546875': '2.35', '3.065232992172241': '2.35', '3.078666925430298': '2.35', '3.093921661376953': '2.35', '3.111555337905884': '2.35', '3.1243250370025635': '2.35', '3.1353771686553955': '2.35', '3.142472743988037': '2.35', '3.1534900665283203': '2.35', '3.16697359085083': '2.285', '3.1828184127807617': '2.285', '3.192929267883301': '2.285', '3.2025067806243896': '2.285', '3.2198903560638428': '2.265', '3.23620867729187': '2.255', '3.2579660415649414': '2.255', '3.281752347946167': '2.25', '3.3026983737945557': '2.25', '3.327641487121582': '2.25', '3.3426713943481445': '2.24', '3.3568427562713623': '2.24', '3.382490396499634': '2.24', '3.4063475131988525': '2.24', '3.4262638092041016': '2.24', '3.4541139602661133': '2.24', '3.4823620319366455': '2.24', '3.50856876373291': '2.215', '3.537752389907837': '2.325', '3.566296339035034': '2.325', '3.599393129348755': '2.285', '3.6217074394226074': '2.285', '3.638439893722534': '2.3', '3.6742749214172363': '2.3', '3.7051045894622803': '2.31', '3.7372024059295654': '2.31', '3.7665536403656006': '2.31', '3.797926902770996': '2.31', '3.8282923698425293': '2.31', '3.8533499240875244': '2.31', '3.8670125007629395': '2.31', '3.8788704872131348': '2.31', '3.903834581375122': '2.31', '3.9311330318450928': '2.31', '3.943755626678467': '2.31', '3.956683397293091': '2.31', '3.9810733795166016': '2.29', '4.01678466796875': '2.285', '4.038576364517212': '2.285', '4.054937362670898': '2.275', '4.088646173477173': '2.275', '4.116137504577637': '2.275', '4.124629259109497': '2.275', '4.134634017944336': '2.275', '4.146299123764038': '2.275', '4.15636682510376': '2.275', '4.16607141494751': '2.275', '4.174594879150391': '2.275', '4.182603359222412': '2.275', '4.192336797714233': '2.275', '4.216179132461548': '2.28', '4.237684011459351': '2.28', '4.25732159614563': '2.28', '4.271304130554199': '2.28', '4.284486293792725': '2.28', '4.298827171325684': '2.28', '4.314821481704712': '2.28', '4.3393638134002686': '2.28', '4.362159252166748': '2.28', '4.380570650100708': '2.28', '4.402044773101807': '2.27', '4.427302598953247': '2.27', '4.450380086898804': '2.265', '4.466681957244873': '2.265', '4.476360321044922': '2.265', '4.485790491104126': '2.265', '4.497633695602417': '2.265', '4.514233350753784': '2.265', '4.540966272354126': '2.265', '4.565483808517456': '2.265', '4.580843448638916': '2.265', '4.597040414810181': '2.265', '4.620746374130249': '2.265', '4.642939567565918': '2.265', '4.651979446411133': '2.265', '4.66023850440979': '2.265', '4.677449703216553': '2.265', '4.7040159702301025': '2.265', '4.720280170440674': '2.2651', '4.735284805297852': '2.2651', '4.750925302505493': '2.265', '4.764741659164429': '2.265', '4.781278371810913': '2.265', '4.798498153686523': '2.265', '4.8127288818359375': '2.265', '4.829133987426758': '2.265', '4.843092203140259': '2.265', '4.860905647277832': '2.265', '4.871904611587524': '2.265', '4.888960123062134': '2.265', '4.906879425048828': '2.265', '4.919458866119385': '2.265', '4.931413173675537': '2.265', '4.943365812301636': '2.265', '4.9725024700164795': '2.265'}
    # RESULTS[video_id] = data 
    data = number_recognition.main(video_path)
    
    return jsonify({"video_id": video_id, "data": data}), 200

# @app.route("/results/<video_id>", methods=["GET"])
# def get_results(video_id):
#     if video_id not in RESULTS:
#         return jsonify({"error": "Results not found"}), 404
#     return jsonify({"video_id": video_id, "data": RESULTS[video_id]}), 200



if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", debug=True, port=port)
    